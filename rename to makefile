
EKS_CLUSTER_NAME := dnd-cluster
AWS_REGION := us-east-1
DB_HOST := dnd-forum-postgres.----------.us-east-1.rds.amazonaws.com
DB_PORT := 5432
DB_USER := -------
DB_PASSWORD := -------
DB_NAME := -------
DB_IDER := --------
VPC_ID := vpc-0abae96f5ad67cf3d
AWS_ACC := 731945947682

.PHONY: init plan apply destroy kubeconfig create-db drop-db start-db stop-db metrics scale app del-app del-alb controller del-controller external-dns del-external-dns


init:
	cd infra && terraform init

plan:
	cd infra && terraform plan

apply:
	cd infra && terraform apply -auto-approve

destroy:
	cd infra && terraform destroy -auto-approve

kubeconfig:
	aws eks update-kubeconfig --region $(AWS_REGION) --name $(EKS_CLUSTER_NAME)

create-db:
	psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -d postgres -c "CREATE DATABASE $(DB_NAME);"

drop-db:
	psql -h $(DB_HOST) -p $(DB_PORT) -U $(DB_USER) -d postgres -c "DROP DATABASE IF EXISTS $(DB_NAME);"

start-db:
	aws rds start-db-instance --db-instance-identifier $(DB_IDER)

stop-db:
	aws rds stop-db-instance --db-instance-identifier $(DB_IDER)

metrics:
	kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.7.2/components.yaml

scale: 
	kubectl scale deploy coredns -n kube-system --replicas 1
	kubectl scale deploy ebs-csi-controller -n kube-system --replicas 1

app:
	kubectl apply -f prod/secret.yaml
	kubectl apply -f prod/dnd-app.yaml

del-app:
	kubectl delete -f prod/dnd-app.yaml
	kubectl delete -f prod/secret.yaml 
    
controller: 
	helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
    --namespace kube-system \
    --set clusterName=$(EKS_CLUSTER_NAME) \
    --set serviceAccount.name=alb-dnd-sa \
    --set region=$(AWS_REGION) \
    --set vpcId=$(VPC_ID) \
    --set serviceAccount.create=true \
    --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=arn:aws:iam::$(AWS_ACC):role/aws-load-balancer-controller

del-controller:
	helm uninstall aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system

external-dns:
	kubectl create ns dnd-forum
	helm install external-dns external-dns/external-dns -n kube-system \
  --set policy=upsert-only \
  --set registry=txt \
  --set sources[0]=ingress \
  --set policy=sync \
  --namespace kube-system \
  --set serviceAccount.create=true \
  --set serviceAccount.name=external-dns \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=arn:aws:iam::$(AWS_ACC):role/external-dns

del-external-dns:
	 helm uninstall external-dns external-dns/external-dns -n kube-system
