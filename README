Firstly, an explanation on the name. I play D&D with my friends once a week, and a friend told me I should make a project using EKS aince I got
my CKA and aws sysops cert. I agreed and decided to make a forum. Not only will I have a finished project to show, it will be functional too.
I first tried to code my own, but that proved to be a waste of time, my friend simply told me to find a package. "It's not your job to code,
you went into orchestration, find a package and hook up all the pieces." So that's what I did.  

You need an AWS account and access to your aws through your terminal.

You will find the image repo at https://github.com/Zaziben/dnd-forum-app

footnotes labelled with a paranthesis (x) at the end of this document.


This repo has everyting you need to create a fully ephemeral, secure phpbb web server, except for the domain name, you'll have to configure one
with route 53. S3 manages media storage such as avatars and attachments, and the database manages everything else, making this a truly stateless
forum. It was never designed for thousands of users, however, you'll have to probabaly configure an rds proxy and a cdn if you are, but those 
would easily slot into the terraform in /statics. 

You will need to replace my specific identifiers and credentials with your own using this repo.

<<<<STEP BY STEP INSTRUCTIONS>>>>

start static infrastructure, the stuff that doesn't change(1)

in /statics, terraform apply

This makes the s3 bucket, the rds instance, the cert to secure your sub domain. 

start EKS cluster:

in /infra, terraform apply 

This makes the cluster and IAM IRSA permissions

You can use the makefile to implement these commands(2)

You need to connect to the cluster:
aws eks update-kubeconfig --region $(AWS_REGION) --name $(EKS_CLUSTER_NAME)

Install the aws controller:

helm repo add eks https://aws.github.io/eks-charts
helm repo update


helm install aws-load-balancer-controller eks/aws-load-balancer-controller \      
    -n kube-system \
    --set region=$(AWS_REGION)
    --set vpcId=$(VPC_ID)
    --set clusterName=$(EKS_CLUSTER_NAME) \
    --set namespace=kube-system \
    --set serviceAccount.create=true \
    --set serviceAccount.name=alb-dnd-sa \
    --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=arn:aws:iam::$(AWS_ACC):role/aws-load-balancer-controller

---wait for webhooks to finalize, 3 minutes---

Install the external DNS (3)

helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
 add external-dns https://kubernetes-sigs.github.io/external-dns/
helm repo update

kubectl create ns xxxx (the namespace you are going to put your app deployment)
helm install external-dns external-dns/external-dns \
  -n kube-system \
  --set policy=upsert-only \
  --set provider=aws \
  --set registry=txt \
  --set sources[0]=ingress \
  --set namespace=xxxx \ # same namespace you are creating in above line
  --set policy=sync \
  --set serviceAccount.create=true \
  --set serviceAccount.name=external-dns \
  --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=arn:aws:iam::$(AWS_ACC):role/external-dns

example secret:
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
  namespace: forum
stringData:
  config.php: |
    <?php
    $dbms = 'phpbb\\db\\driver\\postgres'; # xxxx can be postgres, mysql, whatever db vendor you are using
    $dbhost = 'forum-postgres.xxxxxx.us-east-1.rds.amazonaws.com'; # replace my entry with your db hostname
    $dbport = 'xxxx';
    $dbname = 'xxxxxxx';
    $dbuser = 'xxxxxxx';
    $dbpasswd = 'xxxxxxx';
    $table_prefix = 'phpbb_';
    $phpbb_adm_relative_path = 'adm/';
    $acm_type = 'phpbb\\cache\\driver\\file';

    @define('PHPBB_INSTALLED', true);
    @define('PHPBB_ENVIRONMENT', 'production');
    // @define('DEBUG_CONTAINER', true);

First, you must install phpbb onto the database, so input kubectl apply -f dnd-app-install.yaml from ~/prod

Once live for the first time, exec into the pod and rename the <binstall> folder
in the ~/html directory to <install>(4).

Install phpbb onto your database. Then delete the deployment. Make sure you create a secret for your pod to mount the configs you just entered into your
database, found above, and apply the dnd-app.yaml file to make a new deployment(5)(6) 


----------

(1): You can simply start and stop the database with the makefile

make start-db 
	aws rds start-db-instance --db-instance-identifier $(DB_IDER)

make stop-db
	aws rds stop-db-instance --db-instance-identifier $(DB_IDER)

(2): Credentials you might see in the makefile were for my cluster. I have since rotated them. I did not make a fresh repo so you can see my work. I should
have found a different way to hide my credentials, but this is my first really real project. You live and learn.

make controller and make external-dns are easy commands to perform to get the required connections ready.

(3): We are using a different alb every time, so we need an external DNS to change our routing table in route 53 to let us connect to our domain. This assumes 
you already have a hosted zone you control in route53. We don't manually create the sub domain, the external-dns makes that for us when it reads your ingress, 
A
which you'll have to change into the domain you own.

(4): I made the decision to rename the folder in the image run time because the phpbb server doesn't allow the forum to be used unless the
install folder doesn't exist. Since I only need the install folder for installation, this made sense, you wouldn't want to change the folder every time.
For those new to k8s: kubectl get pod -A, find your pod in the list. Then kubectl exec <podname> -it -n <namespace pod lives> -- bash. In the root directory 
you will find the binstall folder, rename that to install and refresh the webpage. 

(5): For installation to start, the config.php file must not exist at installation time. But you want to be able to automatically connect to the database on
subsequent launches, therefore you create a secret to mount the config file, example above, to your container's filesystem. This
is already done for you with dnd-app.yaml.

(6): For future deployments, after the controller and external-dns is created, a simple <make app> command is simpler than the kubectl inputs.
